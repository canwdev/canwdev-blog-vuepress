(window.webpackJsonp=window.webpackJsonp||[]).push([[51],{656:function(s,a,e){"use strict";e.r(a);var t=e(28),n=Object(t.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"使用-luks-加密-home-目录并在开机时自动解密"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#使用-luks-加密-home-目录并在开机时自动解密"}},[s._v("#")]),s._v(" 使用 LUKS 加密 home 目录并在开机时自动解密")]),s._v(" "),e("p",[s._v("参考：")]),s._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"https://www.cnblogs.com/guarderming/p/11957780.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("用luks方式对磁盘进行加密以及加密磁盘的自动挂载"),e("OutboundLink")],1)]),s._v(" "),e("li",[e("a",{attrs:{href:"http://blog.lujun9972.win/blog/2018/04/12/%E4%BD%BF%E7%94%A8cryptsetup%E5%88%9B%E5%BB%BA%E5%8A%A0%E5%AF%86%E7%A3%81%E7%9B%98/index.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("使用cryptsetup创建加密磁盘"),e("OutboundLink")],1)])]),s._v(" "),e("h2",{attrs:{id:"创建-luks-加密分区"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#创建-luks-加密分区"}},[s._v("#")]),s._v(" 创建 LUKS 加密分区")]),s._v(" "),e("p",[s._v("首先你需要创建一个 luks 加密分区，具体操作参阅上述链接。")]),s._v(" "),e("h2",{attrs:{id:"手动挂载并测试"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#手动挂载并测试"}},[s._v("#")]),s._v(" 手动挂载并测试")]),s._v(" "),e("p",[s._v("使用 "),e("code",[s._v("CTRL + ALT + F2")]),s._v(" 打开一个新的 tty2，并使用 root 登录")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# 查看目标 luks 分区\nlsblk\n\n# 假设目标分区为 /dev/sda3，使用 cryptsetup 解密，名字为 home\ncryptsetup open /dev/sda3 home\n# 此时会要求输入密码，解密成功后会出现在 /dev/mapper/home\n\n# 重命名旧的 home 目录\nmv /home /home.old\n\n# 挂载新的 home 目录（此时应该为空）\nmkdir /home\nmount /dev/mapper/home /home\n\n# 复制原来的文件到新的 home 目录，并保留用户权限\ncp -ax /home.old/* /home/\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br")])]),e("p",[s._v("此时重新登录普通用户，如果登录成功并且 home 目录可以读写，则实验成功。")]),s._v(" "),e("h2",{attrs:{id:"加密设备的开机自动挂载"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#加密设备的开机自动挂载"}},[s._v("#")]),s._v(" 加密设备的开机自动挂载")]),s._v(" "),e("p",[s._v("创建密钥文件，这个文件在开机时会自动读取并解密目标分区：")]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 生成随机字符串，熵越大越好")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("dd")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("if")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/dev/urandom "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("bs")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("count")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[e("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),s._v("/dev/null "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" base64 -w "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("rev")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cut")]),s._v(" -b "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("- "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("rev")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将随机内容写入到一个文件，比如这个")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /root/luks_pass\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置文件权限，只允许 root 读写")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("600")]),s._v(" /root/luks_pass\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("设置开机自动解密 luks 分区："),e("code",[s._v("vim /etc/crypttab")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# <name>  <device>      <password> <options>\nhome    /dev/sda3       /root/luks_pass\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("把密码添加到luks加密中，这一步必须执行才能使密码生效：")]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("cryptsetup luksAddKey /dev/sda3 /root/luks_pass\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 会提示 `Enter any passphrase`，此时请输入分区的加密密码")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("设置 /home 目录的自动挂载点："),e("code",[s._v("vim /etc/fstab")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("/dev/mapper/home        /home   ext4    defaults        0       2\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("重启即可完成。")]),s._v(" "),e("hr"),s._v(" "),e("p",[s._v("如果要修改加密卷密码，或是删除密钥认证，请参考 "),e("a",{attrs:{href:"https://nova.moe/encrypt-disk-with-luks/",target:"_blank",rel:"noopener noreferrer"}},[s._v("保护数据，用 LUKS 给磁盘全盘加密"),e("OutboundLink")],1)])])}),[],!1,null,null,null);a.default=n.exports}}]);