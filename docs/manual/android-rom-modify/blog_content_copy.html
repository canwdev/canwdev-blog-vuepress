<!DOCTYPE html>
<!-- saved from url=(0187)https://luoyesiqiu.github.io/2019/04/30/Android-ROM%E5%8C%85%E5%AE%9A%E5%88%B6%EF%BC%88%E8%A7%A3%E5%8C%85%EF%BC%8C%E5%A2%9E%E5%88%A0%E6%A8%A1%E5%9D%97%EF%BC%8C%E6%89%93%E5%8C%85%EF%BC%89/ -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Android ROM包定制（解包，增删模块，打包） · luoyesiqiu的博客</title><meta name="description" content="Android ROM包定制（解包，增删模块，打包） - luoyesiqiu"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="https://luoyesiqiu.github.io/favicon.ico"><link rel="stylesheet" href="./Android ROM包定制（解包，增删模块，打包） · luoyesiqiu的博客_files/prontera.css"><link rel="search" type="application/opensearchdescription+xml" href="https://luoyesiqiu.github.io/atom.xml" title="luoyesiqiu的博客"><script src="./Android ROM包定制（解包，增删模块，打包） · luoyesiqiu的博客_files/analytics.js.下载"></script><script type="text/javascript" async="" src="./Android ROM包定制（解包，增删模块，打包） · luoyesiqiu的博客_files/embed.js.下载"></script><link rel="prefetch" as="style" href="https://c.disquscdn.com/next/embed/styles/lounge.c46a5b3df6acec9d5cde6bf8b61aaf6e.css"><link rel="prefetch" as="script" href="https://c.disquscdn.com/next/embed/common.bundle.57d935b03ca64a8fc2ae95b8d550f132.js"><link rel="prefetch" as="script" href="https://c.disquscdn.com/next/embed/lounge.bundle.10adfde1a6e883b828255fddc56fa508.js"><link rel="prefetch" as="script" href="https://disqus.com/next/config.js"></head><body><header class="feature-header"><nav class="component-nav"><ul><div class="logo-container"><a href="https://luoyesiqiu.github.io/"><h2 class="title">luoyesiqiu的博客</h2></a></div><a href="https://luoyesiqiu.github.io/" target="_self" class="li component-nav-item"><p>首页</p></a><a href="https://luoyesiqiu.github.io/about" target="_self" class="li component-nav-item"><p>关于</p></a><ul class="shortcut-icons"><a href="https://github.com/luoyesiqiu" target="_blank"><img src="./Android ROM包定制（解包，增删模块，打包） · luoyesiqiu的博客_files/github.svg" class="icon"></a><a href="https://luoyesiqiu.github.io/atom.xml" target="_blank"><img src="./Android ROM包定制（解包，增删模块，打包） · luoyesiqiu的博客_files/rss.svg" class="icon"></a></ul></ul></nav></header><main class="container"><div id="post-container"><div class="post"><article class="post-block"><h1 class="post-title">Android ROM包定制（解包，增删模块，打包）</h1><div class="post-info">Apr 30, 2019</div><div class="post-content"><p>以前刚用手机的时候，经常可以在玩机论坛上看到很多发ROM包的帖子，譬如什么大深度定制ROM，什么大深度深度精简纯净版ROM…相信很多喜欢搞机的都有见过这类帖子。后来自己不满每次刷机后都要手动设置一大堆东西，遂按照论坛上的教程改了Defy+的cm11的ROM，集成了绿色守护，默认允许安装未知来源的应用，默认电池百分号显示等等。时隔4年，又玩起了ROM包定制，感慨颇多</p>
<h1 id="1-解包"><a href="https://luoyesiqiu.github.io/2019/04/30/Android-ROM%E5%8C%85%E5%AE%9A%E5%88%B6%EF%BC%88%E8%A7%A3%E5%8C%85%EF%BC%8C%E5%A2%9E%E5%88%A0%E6%A8%A1%E5%9D%97%EF%BC%8C%E6%89%93%E5%8C%85%EF%BC%89/#1-%E8%A7%A3%E5%8C%85" class="headerlink" title="1. 解包"></a>1. 解包</h1><p>假设有一个名为update.zip的ROM包，我们要在Ubuntu下对它进行定制。首先把<code>system.transfer.list</code>和<code>system.new.dat.br</code>（有些旧版的系统的镜像可能是system.new.dat）从update.zip解压出来，转成system.img（原始镜像格式），修改完后又按步骤打包回原来的格式。本文只写了system分区的定制方法，但是对于其他分区也是类似的，都要转成原始镜像格式后才能对它修改。如果使用<code>file system.img</code>命令来查看system.img文件信息，会得到类似下面的信息：<br></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">system.img: Linux rev 1.0 ext4 filesystem data, UUID=da594c53-9beb-f85c-85c5-cedf76546f7a, volume name "system" (extents) (large files)</span><br></pre></td></tr></tbody></table></figure><p></p>
<h2 id="1-1-system-new-dat-br转换为system-new-dat"><a href="https://luoyesiqiu.github.io/2019/04/30/Android-ROM%E5%8C%85%E5%AE%9A%E5%88%B6%EF%BC%88%E8%A7%A3%E5%8C%85%EF%BC%8C%E5%A2%9E%E5%88%A0%E6%A8%A1%E5%9D%97%EF%BC%8C%E6%89%93%E5%8C%85%EF%BC%89/#1-1-system-new-dat-br%E8%BD%AC%E6%8D%A2%E4%B8%BAsystem-new-dat" class="headerlink" title="1.1 system.new.dat.br转换为system.new.dat"></a>1.1 system.new.dat.br转换为system.new.dat</h2><p><code>brotli -d system.new.dat.br</code></p>
<blockquote>
<p>注：如果镜像就是system.new.dat格式，就跳过这步</p>
</blockquote>
<h2 id="1-2-system-new-dat转成system-img"><a href="https://luoyesiqiu.github.io/2019/04/30/Android-ROM%E5%8C%85%E5%AE%9A%E5%88%B6%EF%BC%88%E8%A7%A3%E5%8C%85%EF%BC%8C%E5%A2%9E%E5%88%A0%E6%A8%A1%E5%9D%97%EF%BC%8C%E6%89%93%E5%8C%85%EF%BC%89/#1-2-system-new-dat%E8%BD%AC%E6%88%90system-img" class="headerlink" title="1.2 system.new.dat转成system.img"></a>1.2 system.new.dat转成system.img</h2><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/xpirt/sdat2img</span><br><span class="line">cd sdat2img</span><br><span class="line">python sdat2img.py system.transfer.list system.new.dat system.img</span><br></pre></td></tr></tbody></table></figure>
<h2 id="1-3-挂载system-img"><a href="https://luoyesiqiu.github.io/2019/04/30/Android-ROM%E5%8C%85%E5%AE%9A%E5%88%B6%EF%BC%88%E8%A7%A3%E5%8C%85%EF%BC%8C%E5%A2%9E%E5%88%A0%E6%A8%A1%E5%9D%97%EF%BC%8C%E6%89%93%E5%8C%85%EF%BC%89/#1-3-%E6%8C%82%E8%BD%BDsystem-img" class="headerlink" title="1.3 挂载system.img"></a>1.3 挂载system.img</h2><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p /mnt/system</span><br><span class="line">sudo mount -o loop system.img /mnt/system</span><br></pre></td></tr></tbody></table></figure>
<h2 id="1-4-扩容（可选）"><a href="https://luoyesiqiu.github.io/2019/04/30/Android-ROM%E5%8C%85%E5%AE%9A%E5%88%B6%EF%BC%88%E8%A7%A3%E5%8C%85%EF%BC%8C%E5%A2%9E%E5%88%A0%E6%A8%A1%E5%9D%97%EF%BC%8C%E6%89%93%E5%8C%85%EF%BC%89/#1-4-%E6%89%A9%E5%AE%B9%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89" class="headerlink" title="1.4 扩容（可选）"></a>1.4 扩容（可选）</h2><p>挂载后可以通过<code>df -h</code>来查看挂载点<code>/mnt/system</code>剩余空间有多少，如果没有剩余，就要对它进行扩容，下面的例子是给它增加128M的空间，扩容之前要先取消挂载</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dd if=/dev/zero bs=1M count=128 &gt;&gt; system.img</span><br><span class="line">e2fsck -f system.img</span><br><span class="line">resize2fs system.img</span><br></pre></td></tr></tbody></table></figure>
<h1 id="2-修改"><a href="https://luoyesiqiu.github.io/2019/04/30/Android-ROM%E5%8C%85%E5%AE%9A%E5%88%B6%EF%BC%88%E8%A7%A3%E5%8C%85%EF%BC%8C%E5%A2%9E%E5%88%A0%E6%A8%A1%E5%9D%97%EF%BC%8C%E6%89%93%E5%8C%85%EF%BC%89/#2-%E4%BF%AE%E6%94%B9" class="headerlink" title="2. 修改"></a>2. 修改</h1><p>现在，可以在/mnt/system目录下根据自己的需求增删文件了</p>
<p><img src="./Android ROM包定制（解包，增删模块，打包） · luoyesiqiu的博客_files/o_system_files.png" alt="system_files"></p>
<p>增删文件需要注意：</p>
<ol>
<li>对/mnt/system进行写操作需要root权限</li>
<li>如果需要往/system/app目录或者/system/priv-app目录下加入自己的apk,需要注意除了把apk复制进去外，还要把apk里面的so文件复制进去（如果有的话），复制进去时注意apk和so文件的路径，可以参考其他系统App是怎么存放的</li>
<li>对于非Apk文件，复制进去后，还要使用chmod,chown等命令给它们合理的权限才能生效</li>
</ol>
<h1 id="3-打包"><a href="https://luoyesiqiu.github.io/2019/04/30/Android-ROM%E5%8C%85%E5%AE%9A%E5%88%B6%EF%BC%88%E8%A7%A3%E5%8C%85%EF%BC%8C%E5%A2%9E%E5%88%A0%E6%A8%A1%E5%9D%97%EF%BC%8C%E6%89%93%E5%8C%85%EF%BC%89/#3-%E6%89%93%E5%8C%85" class="headerlink" title="3. 打包"></a>3. 打包</h1><p>打包其实就是解包的逆过程</p>
<h2 id="3-1-生成system-img"><a href="https://luoyesiqiu.github.io/2019/04/30/Android-ROM%E5%8C%85%E5%AE%9A%E5%88%B6%EF%BC%88%E8%A7%A3%E5%8C%85%EF%BC%8C%E5%A2%9E%E5%88%A0%E6%A8%A1%E5%9D%97%EF%BC%8C%E6%89%93%E5%8C%85%EF%BC%89/#3-1-%E7%94%9F%E6%88%90system-img" class="headerlink" title="3.1 生成system.img"></a>3.1 生成system.img</h2><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo make_ext4fs -T 0 -S file_contexts -l 1024M -a system system_new.img /mnt/system</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>-T 代表对镜像中的unix文件时间戳进行设置，这里设置为0，表示1970-1-1</li>
<li>-S 指定file_contexts</li>
<li>-l 表示目标镜像的大小。如果不懂得写多少可以使用<code>df -h</code>命令查看挂载点<code>/mnt/system</code>的总大小，然后取整数（512M,1024M,2048M…），比如查得挂载点空间大小是992M,你就得写1024M</li>
<li>-a 指定目标img文件在Android中的挂载点</li>
<li>system_new.img 表示生成的镜像</li>
<li>/mnt/system/ 表示源目录</li>
</ul>
<blockquote>
<p>注： file_contexts可以去<a href="https://github.com/LineageOS/android_system_sepolicy" target="_blank" rel="noopener">这里</a>获取，根据系统版本选择分支(Android7.0对应的是cm14.0分支，Android7.1对应的是cm14.1分支，Android8.0对应lineage-15.0分支,以此类推)，下载后也可以根据自己的需求定制file_contexts</p>
</blockquote>
<p>成功后会在当前目录下生成system_new.img。如果发生错误，根据错误进行调整参数，直到没有错误提示为止。</p>
<h2 id="3-2-卸载system"><a href="https://luoyesiqiu.github.io/2019/04/30/Android-ROM%E5%8C%85%E5%AE%9A%E5%88%B6%EF%BC%88%E8%A7%A3%E5%8C%85%EF%BC%8C%E5%A2%9E%E5%88%A0%E6%A8%A1%E5%9D%97%EF%BC%8C%E6%89%93%E5%8C%85%EF%BC%89/#3-2-%E5%8D%B8%E8%BD%BDsystem" class="headerlink" title="3.2 卸载system"></a>3.2 卸载system</h2><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo umount /mnt/system</span><br></pre></td></tr></tbody></table></figure>
<h2 id="3-3-把system-img转成system-new-dat"><a href="https://luoyesiqiu.github.io/2019/04/30/Android-ROM%E5%8C%85%E5%AE%9A%E5%88%B6%EF%BC%88%E8%A7%A3%E5%8C%85%EF%BC%8C%E5%A2%9E%E5%88%A0%E6%A8%A1%E5%9D%97%EF%BC%8C%E6%89%93%E5%8C%85%EF%BC%89/#3-3-%E6%8A%8Asystem-img%E8%BD%AC%E6%88%90system-new-dat" class="headerlink" title="3.3 把system.img转成system.new.dat"></a>3.3 把system.img转成system.new.dat</h2><p>转换之前可以对之前解压出来的文件进行备份：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mv system.transfer.list system.transfer.list.bak</span><br><span class="line">mv system.new.dat system.new.dat.bak</span><br></pre></td></tr></tbody></table></figure>
<p>开始转换<br></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/jazchen/rimg2sdat</span><br><span class="line">cd rimg2sdat</span><br><span class="line">python rimg2sdat.py system_new.img</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>成功后会在当前目录下生成system.transfer.list和system.new.dat</p>
<h2 id="3-4-system-new-dat转成system-new-dat-br"><a href="https://luoyesiqiu.github.io/2019/04/30/Android-ROM%E5%8C%85%E5%AE%9A%E5%88%B6%EF%BC%88%E8%A7%A3%E5%8C%85%EF%BC%8C%E5%A2%9E%E5%88%A0%E6%A8%A1%E5%9D%97%EF%BC%8C%E6%89%93%E5%8C%85%EF%BC%89/#3-4-system-new-dat%E8%BD%AC%E6%88%90system-new-dat-br" class="headerlink" title="3.4 system.new.dat转成system.new.dat.br"></a>3.4 system.new.dat转成system.new.dat.br</h2><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brotli -0 system.new.dat</span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<p>注：如果开始解压出来的镜像就是system.new.dat格式，就跳过这步</p>
</blockquote>
<h2 id="3-5-更新文件到刷机包"><a href="https://luoyesiqiu.github.io/2019/04/30/Android-ROM%E5%8C%85%E5%AE%9A%E5%88%B6%EF%BC%88%E8%A7%A3%E5%8C%85%EF%BC%8C%E5%A2%9E%E5%88%A0%E6%A8%A1%E5%9D%97%EF%BC%8C%E6%89%93%E5%8C%85%EF%BC%89/#3-5-%E6%9B%B4%E6%96%B0%E6%96%87%E4%BB%B6%E5%88%B0%E5%88%B7%E6%9C%BA%E5%8C%85" class="headerlink" title="3.5 更新文件到刷机包"></a>3.5 更新文件到刷机包</h2><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zip update.zip &lt;system.new.dat.br或者system.new.dat&gt; system.transfer.list</span><br></pre></td></tr></tbody></table></figure>
<h1 id="4-扩展知识"><a href="https://luoyesiqiu.github.io/2019/04/30/Android-ROM%E5%8C%85%E5%AE%9A%E5%88%B6%EF%BC%88%E8%A7%A3%E5%8C%85%EF%BC%8C%E5%A2%9E%E5%88%A0%E6%A8%A1%E5%9D%97%EF%BC%8C%E6%89%93%E5%8C%85%EF%BC%89/#4-%E6%89%A9%E5%B1%95%E7%9F%A5%E8%AF%86" class="headerlink" title="4. 扩展知识"></a>4. 扩展知识</h1><p>在有些刷机包里，它里面包含的system.img镜像是<code>sparse image</code>格式的，如果用file命令查看它的信息，显示如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">system.img: Android sparse image, version: 1.0, Total of 655360 4096-byte output blocks in 6009 input chunks.</span><br></pre></td></tr></tbody></table></figure>
<p>对于这种格式的镜像，如果想把它挂载和修改，就要转成我们上面提到的raw image（原始镜像）格式，命令如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">simg2img &lt;sparse_image_files&gt; &lt;raw_image_file&gt;</span><br></pre></td></tr></tbody></table></figure>
<p>修改完成后，取消挂载，再使用下面的命令将<code>raw image</code>转成<code>sparse image</code>:</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">img2simg &lt;raw_image_file&gt; &lt;sparse_image_file&gt; [&lt;block_size&gt;]</span><br></pre></td></tr></tbody></table></figure>
<h1 id="5-总结"><a href="https://luoyesiqiu.github.io/2019/04/30/Android-ROM%E5%8C%85%E5%AE%9A%E5%88%B6%EF%BC%88%E8%A7%A3%E5%8C%85%EF%BC%8C%E5%A2%9E%E5%88%A0%E6%A8%A1%E5%9D%97%EF%BC%8C%E6%89%93%E5%8C%85%EF%BC%89/#5-%E6%80%BB%E7%BB%93" class="headerlink" title="5. 总结"></a>5. 总结</h1><p>相对于修改Android源码的方式，直接修改镜像的方法对PC配置要求低很多。如果我们只想增加一些现有的模块和删除不必要的模块，这是很好的方式。而且对于一些手机厂商，他们没有提供Android源码，我们就只能用直接修改镜像的方式来定制我们的ROM。修改ROM的方法是灵活的，总结下来就是，看见一个镜像，可以根据后缀名和file命令确认它的格式，看情况将它转成原始镜像格式并挂载，就可以修改了，修改后又转回它原来的格式，最后替换刷机包中原有的镜像</p>
</div></article></div><div id="disqus_thread"><iframe id="dsq-app7820" name="dsq-app7820" allowtransparency="true" frameborder="0" scrolling="no" tabindex="0" title="Disqus" width="100%" src="./Android ROM包定制（解包，增删模块，打包） · luoyesiqiu的博客_files/saved_resource.html" style="width: 1px !important; min-width: 100% !important; border: none !important; overflow: hidden !important; height: 75px !important;" horizontalscrolling="no" verticalscrolling="no"></iframe></div></div><script>var disqus_shortname = 'luoyesiqiu';
var disqus_identifier = '2019/04/30/Android-ROM包定制（解包，增删模块，打包）/';
var disqus_title = 'Android ROM包定制（解包，增删模块，打包）';
var disqus_url = 'https://luoyesiqiu.github.io/2019/04/30/Android-ROM包定制（解包，增删模块，打包）/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="./Android ROM包定制（解包，增删模块，打包） · luoyesiqiu的博客_files/count.js.下载" async=""></script></main><footer class="footer-container"><div class="paginator"><a href="https://luoyesiqiu.github.io/2019/05/17/IDEA%E7%94%9F%E6%88%90%E5%8F%AF%E6%89%A7%E8%A1%8C%E7%9A%84jar%E6%96%87%E4%BB%B6/" class="prev">上一篇</a><a href="https://luoyesiqiu.github.io/2019/04/19/C%E8%AF%AD%E8%A8%80sprintf%E5%92%8Csscanf%E5%87%BD%E6%95%B0%E7%94%A8%E6%B3%95/" class="next">下一篇</a></div><div class="copyright"><p>© 2018 - 2019 <a href="https://luoyesiqiu.github.io/">luoyesiqiu</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/AngryPowman/hexo-theme-prontera" target="_blank">hexo-theme-prontera</a>.</p></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"luoyesiqiu",'auto');ga('send','pageview');</script><iframe style="display: none;" src="./Android ROM包定制（解包，增删模块，打包） · luoyesiqiu的博客_files/saved_resource(1).html"></iframe></body></html>